---
- include_vars: ../../global-vars.yml

- name: install apt packages
  apt:
    name: gnupg

- name: add apt repository key (legacy)
  apt_key:
    url: 'https://download.docker.com/linux/{{ ansible_facts["distribution"] | lower }}/gpg'
  when: not (ansible_facts["distribution"] == "Debian" and ansible_facts["distribution_major_version"]|int >= 13)

- name: add apt repository (legacy)
  apt_repository:
    repo: 'deb [arch={{ deb_architecture[ansible_facts["architecture"]] }}] https://download.docker.com/linux/{{ ansible_facts["distribution"] | lower }} {{ ansible_facts["distribution_release"] }} stable'
  when: not (ansible_facts["distribution"] == "Debian" and ansible_facts["distribution_major_version"]|int >= 13)

- name: create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  when: ansible_facts["distribution"] == "Debian" and ansible_facts["distribution_major_version"]|int >= 13

- name: add Docker GPG key
  get_url:
    url: 'https://download.docker.com/linux/{{ ansible_facts["distribution"] | lower }}/gpg'
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
  when: ansible_facts["distribution"] == "Debian" and ansible_facts["distribution_major_version"]|int >= 13

- name: add apt repository
  apt_repository:
    repo: 'deb [arch={{ deb_architecture[ansible_facts["architecture"]] }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/{{ ansible_facts["distribution"] | lower }} {{ ansible_facts["distribution_release"] }} stable'
  when: ansible_facts["distribution"] == "Debian" and ansible_facts["distribution_major_version"]|int >= 13

- name: install apt packages
  apt:
    name: docker-ce
    update_cache: true

# Always write daemon.json to ensure live-restore is enabled, which keeps
# containers running during dockerd restarts (e.g. daemon config changes or
# package upgrades). Without live-restore, dockerd restart causes all containers
# to restart with new ports, breaking Nomad bridge network connectivity (the
# veth pairs are lost and iptables rules become stale).
- name: setup docker daemon config
  vars:
    daemon_config: >-
      {{
        {'live-restore': true}
        | combine((docker_registry_url | length > 0) | ternary({'registry-mirrors': [docker_registry_url]}, {}))
        | combine((docker_insecure_registries | length > 0) | ternary({'insecure-registries': docker_insecure_registries}, {}))
      }}
  copy:
    content: "{{ daemon_config | to_nice_json }}\n"
    dest: /etc/docker/daemon.json
  notify: restart docker

- include_tasks: remote.yml
  when: docker_cert_name | length > 0
